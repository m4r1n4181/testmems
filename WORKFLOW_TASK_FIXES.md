# MediaWorkflow and MediaTask Relationship Fixes

## Summary
Fixed critical issues preventing the creation and updating of MediaWorkflows with their associated MediaTasks. The relationship between MediaWorkflow (one) and MediaTask (many) now works correctly on both backend and frontend.

## Issues Fixed

### 1. Backend: MediaTaskCreateDto WorkflowId Requirement Issue
**Problem:** `MediaTaskCreateDto` had `WorkflowId` marked as `[Required]`, but when creating a workflow with tasks in a single operation, the workflow doesn't have an ID yet (it's generated by the database upon save).

**Solution:** Made `WorkflowId` optional in `MediaTaskCreateDto`:
```csharp
// Changed from: [Required] public int WorkflowId { get; set; }
// To:
public int? WorkflowId { get; set; }
```

**File:** `MusicEventManagementSystem.API/DTOs/MediaCampaign/MediaTaskDto.cs`

### 2. Backend: CreateMediaWorkflowAsync Setting WorkflowId Before Save
**Problem:** The `CreateMediaWorkflowAsync` method was trying to set `WorkflowId = workflow.MediaWorkflowId` before the workflow was persisted, resulting in `WorkflowId = 0`.

**Solution:** Removed the explicit WorkflowId assignment and let Entity Framework Core handle the relationship automatically when the workflow is saved:
```csharp
// Removed: WorkflowId = workflow.MediaWorkflowId,
// EF Core automatically sets WorkflowId when workflow.Tasks.Add(task) is used
// and the workflow is saved to the database
```

**File:** `MusicEventManagementSystem.API/Services/MediaWorkflowService.cs`

### 3. Backend: UpdateMediaWorkflowAsync Not Setting WorkflowId
**Problem:** When updating a workflow's tasks, the new tasks weren't getting the `WorkflowId` properly set.

**Solution:** Explicitly set `WorkflowId` in the update method since the workflow already exists:
```csharp
workflow.Tasks.Add(new MediaTask
{
    // ... other properties
    WorkflowId = workflow.MediaWorkflowId,  // Explicitly set for updates
    // ...
});
```

**File:** `MusicEventManagementSystem.API/Services/MediaWorkflowService.cs`

### 4. Backend: MediaTaskService MapToEntity Conversion Error
**Problem:** `MapToEntity` method had a compilation error because `WorkflowId` was changed to nullable but the entity expects non-nullable int.

**Solution:** Handle the nullable WorkflowId with a default value:
```csharp
WorkflowId = dto.WorkflowId ?? 0,  // Default to 0 if not provided
```

**File:** `MusicEventManagementSystem.API/Services/MediaTaskService.cs`

### 5. Backend: DbContext Manager Requirement Mismatch
**Problem:** The DbContext marked `ManagerId` as required, but the model defines it as nullable, causing potential foreign key constraint violations.

**Solution:** Changed the relationship configuration to mark Manager as optional:
```csharp
// Changed from: .IsRequired()
// To:
.IsRequired(false)  // Manager is optional
```

**File:** `MusicEventManagementSystem.API/Data/ApplicationDbContext.cs`

## How It Works Now

### Creating a Workflow with Tasks (Frontend â†’ Backend)
1. Frontend sends a `CreateMediaWorkflowForm` with:
   - `workflowDescription`: string
   - `tasks`: array of `{ taskName, order, taskStatus }`

2. Backend receives it as `MediaWorkflowCreateDto`

3. Backend creates a new `MediaWorkflow` entity

4. For each task DTO, backend creates a `MediaTask` entity and adds it to `workflow.Tasks` collection

5. EF Core automatically:
   - Saves the workflow first
   - Gets the generated `MediaWorkflowId`
   - Sets `WorkflowId` on all tasks in the collection
   - Saves the tasks

### Updating a Workflow with Tasks
1. Frontend sends an `UpdateMediaWorkflowForm` with updated task list

2. Backend clears existing tasks: `workflow.Tasks.Clear()`

3. Backend creates new task entities and explicitly sets `WorkflowId = workflow.MediaWorkflowId`

4. Backend saves changes

## Frontend Compatibility
The frontend code was already correctly structured and requires no changes:
- `CreateMediaWorkflowForm` and `UpdateMediaWorkflowForm` send the correct data structure
- `MediaTaskForm` interface matches the backend DTOs
- Service methods correctly call the API endpoints

## Testing Recommendations
1. **Create Workflow with Tasks**: Create a new workflow and add multiple tasks in a single operation
2. **Update Workflow Tasks**: Edit an existing workflow and modify its tasks
3. **Delete Workflow**: Ensure tasks are deleted when workflow is deleted (cascade delete)
4. **Fetch Workflow**: Verify that tasks are included when retrieving workflow details

## Files Modified
1. `MusicEventManagementSystem.API/DTOs/MediaCampaign/MediaTaskDto.cs`
2. `MusicEventManagementSystem.API/Services/MediaWorkflowService.cs`
3. `MusicEventManagementSystem.API/Services/MediaTaskService.cs`
4. `MusicEventManagementSystem.API/Data/ApplicationDbContext.cs`

## Notes
- The relationship is properly configured in the database schema
- The repository includes tasks when fetching workflows (`.Include(mw => mw.Tasks)`)
- No frontend changes were needed
- The API builds successfully with no errors
- All changes follow existing code conventions and patterns
